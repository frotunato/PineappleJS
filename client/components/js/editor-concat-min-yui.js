var editor=document.getElementById("editor");var editorButton=document.getElementById("editor-button");var editorHiddenInput=document.getElementById("editor-hidden-input");var editorFilenameInput=document.getElementById("editor-filename");var editorCtrl={resetCaretPosition:function(a){if(document.createRange){var b=document.getSelection();console.log("ended up selecting",b,a);var c=editor.childNodes[this.getCurrentLine(b).index];rng=document.createRange();rng.selectNodeContents(a);rng.collapse(false);b=window.getSelection();b.removeAllRanges();b.addRange(rng)}},getCurrentLine:function(f,c,d){f=(!f)?document.getSelection():f;var e=(!d)?f.anchorNode:f;d=(d)?d:f;c=(!c)?0:c;if((!e.parentNode.previousSibling&&e.nodeName==="#text")||(e.parentNode.id==="editor"&&!e.previousSibling)){var a=d.anchorNode.textContent.lastIndexOf(" ");var b=d.anchorNode.textContent.match(/[\/\s(](?!.*[\/\s(])/);b=(b)?b.index+1:-1;return{index:c,lastWord:d.anchorNode.textContent.substring(b,d.anchorOffset),lastSpacerOffset:b,sourceElement:d}}else{if(e.nodeName==="DIV"&&e.previousSibling){return this.getCurrentLine(e.previousSibling,c+1,d)}else{if(e.nodeName==="#text"&&e.parentNode.id!=="editor"){return this.getCurrentLine(e.parentNode.previousSibling,c+1,d)}}}},replaceReservedWords:function(){var h=this.getCurrentLine();var f=editor.childNodes[h.index];var b=f.innerHTML.match(/(\bif\b|\belse\b|\bvar\b|[~=])(?!(<\/span>|"))/gi);if(b){console.log(b);var g;var d=document.createElement("span");var a=document.createTextNode("");var e=document.getSelection();d.contentEditable="false";for(var c=b.length-1;c>=0;c--){switch(b[c]){case"~":d.className="coordinate";break;case"=":case"if":case"else":d.className="control-flow-statement";break;case"var":d.className="variable"}findAndReplaceDOMText(f,{find:b[c],wrap:d});(!e.anchorNode.nextSibling)?e.anchorNode.insertBefore(a,e.anchorNode.nextSibling):null}editorCtrl.resetCaretPosition(f)}},fixEmptyParent:function(){if(editor.innerHTML==="<br>"||editor.innerHTML===""){console.log("now");var b=document.createElement("div");var a=document.createElement("br");b.appendChild(a);(editor.innerHTML==="<br>")?editor.replaceChild(b,editor.firstChild):editor.appendChild(b)}},getTextContent:function(){var b="";for(var a=0;a<editor.childNodes.length;a++){b+=editor.childNodes[a].textContent+"\n"}console.log("str is",b);return b},setTextContent:function(){editorHiddenInput.value=editorCtrl.getTextContent()},sendTextContent:function(a){var b=new XMLHttpRequest();console.log("textContent is",a);b.onreadystatechange=function(){if(b.readyState===4){console.log("we have something",b.responseText)}};b.open("POST","schematic",true);b.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");b.send("source="+a)}};var autocomplete={active:false,matches:[],_lastIndex:0,_lastWord:"",_lastOffset:0,getMatchSet:function(e){var a=["achievement","ban","ban-ip","banlist","blockdata","clear","clone","debug","defaultgamemode","deop","difficulty","effect","enchant","entitydata","execute","fill","gamemode","gamerule","give","help","kick","kill","list","me","op","pardon","particle","playsound","publish","replaceitem","save","save-all","save-off","save-on","say","scoreboard","seed","setblock","setidletimeout","setworldspawn","spawnpoint","spreadplayers","stats","stop","stopsound","summon","teleport","tell","tellraw","testfor","testforblock","testforblocks","time","title","toggledownfall","tp","trigger","weather","whitelist","worldborder","xp"];var c=[];var d=e.replace("/","").replace("(","").replace("&nbsp;","");console.log("trying to match",d);for(var b=a.length-1;b>=0;b--){if(a[b].startsWith(d)){c.push(a[b])}}return c},reset:function(){this._lastWord="";this._lastOffset=0;this._lastIndex=0;this.active=false;this.matches=[]},_replace:function(c,e,d){var a=c.anchorNode;var b=this.matches[this._lastIndex];if(!b){this._lastIndex=0;b=this.matches[this._lastIndex]}else{if(d===b||this.matches.length===0){return}}this._lastWord=b;this._lastIndex++;console.log("_replace here, working with",d,"offset",e,"element",a);if(e>0){a.splitText(e);a=a.nextSibling}console.log("_replace here, working with next",b,"offset",e,"element",a);console.log("matches",this.matches);findAndReplaceDOMText(a,{find:d,replace:b});this._lastOffset=e+d.length},cycle:function(){var a=editorCtrl.getCurrentLine();if(this.active){console.log("now going with",a.sourceElement);this._replace(a.sourceElement,-1,this._lastWord)}else{this.matches=this.getMatchSet(a.lastWord);this.active=true;this._replace(a.sourceElement,a.lastSpacerOffset,a.lastWord)}}};editor.onkeyup=function(b){var a=String.fromCharCode(b.which);editorCtrl.fixEmptyParent();if(/[a-z\d]/i.test(a)){autocomplete.reset();editorCtrl.replaceReservedWords()}};editor.onkeydown=function(a){if(editor.innerHTML.length===0||editor.innerHTML==="<br>"){}if(event.which===17||event.keyCode===17){}if(a.which===9){a.preventDefault();autocomplete.cycle(editorCtrl.getCurrentLine())}};(function(a,b){if(typeof module==="object"&&module.exports){module.exports=b()}else{if(typeof define==="function"&&define.amd){define(b)}else{a.findAndReplaceDOMText=b()}}}(this,function factory(){var k="retain";var b="first";var j=document;var d={}.toString;var h={}.hasOwnProperty;function i(l){return d.call(l)=="[object Array]"}function f(l){return String(l).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")}function g(){return e.apply(null,arguments)||a.apply(null,arguments)}function e(r,q,o,m,p){if((q&&!q.nodeType)&&arguments.length<=2){return false}var n=typeof o=="function";if(n){o=(function(s){return function(u,t){return s(u.text,t.startIndex)}}(o))}var l=a(q,{find:r,wrap:n?null:o,replace:n?o:"$"+(m||"&"),prepMatch:function(s,t){if(!s[0]){throw"findAndReplaceDOMText cannot handle zero-length matches"}if(m>0){var u=s[m];s.index+=s[0].indexOf(u);s[0]=u}s.endIndex=s.index+s[0].length;s.startIndex=s.index;s.index=t;return s},filterElements:p});g.revert=function(){return l.revert()};return true}function a(m,l){return new c(m,l)}g.NON_PROSE_ELEMENTS={br:1,hr:1,script:1,style:1,img:1,video:1,audio:1,canvas:1,svg:1,map:1,object:1,input:1,textarea:1,select:1,option:1,optgroup:1,button:1};g.NON_CONTIGUOUS_PROSE_ELEMENTS={address:1,article:1,aside:1,blockquote:1,dd:1,div:1,dl:1,fieldset:1,figcaption:1,figure:1,footer:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,header:1,hgroup:1,hr:1,main:1,nav:1,noscript:1,ol:1,output:1,p:1,pre:1,section:1,ul:1,br:1,li:1,summary:1,dt:1,details:1,rp:1,rt:1,rtc:1,script:1,style:1,img:1,video:1,audio:1,canvas:1,svg:1,map:1,object:1,input:1,textarea:1,select:1,option:1,optgroup:1,button:1,table:1,tbody:1,thead:1,th:1,tr:1,td:1,caption:1,col:1,tfoot:1,colgroup:1};g.NON_INLINE_PROSE=function(l){return h.call(g.NON_CONTIGUOUS_PROSE_ELEMENTS,l.nodeName.toLowerCase())};g.PRESETS={prose:{forceContext:g.NON_INLINE_PROSE,filterElements:function(l){return !h.call(g.NON_PROSE_ELEMENTS,l.nodeName.toLowerCase())}}};g.Finder=c;function c(o,l){var n=l.preset&&g.PRESETS[l.preset];l.portionMode=l.portionMode||k;if(n){for(var m in n){if(h.call(n,m)&&!h.call(l,m)){l[m]=n[m]}}}this.node=o;this.options=l;this.prepMatch=l.prepMatch||this.prepMatch;this.reverts=[];this.matches=this.search();if(this.matches.length){this.processMatches()}}c.prototype={search:function(){var o;var l=0;var s=0;var q=this.options.find;var p=this.getAggregateText();var r=[];var n=this;q=typeof q==="string"?RegExp(f(q),"g"):q;m(p);function m(v){for(var u=0,t=v.length;u<t;++u){var w=v[u];if(typeof w!=="string"){m(w);continue}if(q.global){while(o=q.exec(w)){r.push(n.prepMatch(o,l++,s))}}else{if(o=w.match(q)){r.push(n.prepMatch(o,0,s))}}s+=w.length}}return r},prepMatch:function(n,l,m){if(!n[0]){throw new Error("findAndReplaceDOMText cannot handle zero-length matches")}n.endIndex=m+n.index+n[0].length;n.startIndex=m+n.index;n.index=l;return n},getAggregateText:function(){var n=this.options.filterElements;var m=this.options.forceContext;return l(this.node);function l(q,o){if(q.nodeType===3){return[q.data]}if(n&&!n(q)){return[]}var o=[""];var p=0;if(q=q.firstChild){do{if(q.nodeType===3){o[p]+=q.data;continue}var r=l(q);if(m&&q.nodeType===1&&(m===true||m(q))){o[++p]=r;o[++p]=""}else{if(typeof r[0]==="string"){o[p]+=r.shift()}if(r.length){o[++p]=r;o[++p]=""}}}while(q=q.nextSibling)}return o}},processMatches:function(){var q=this.matches;var m=this.node;var x=this.options.filterElements;var o,v,l=[],n=m,r=q.shift(),s=0,w=0,t=0,u,p=[m];out:while(true){if(n.nodeType===3){if(!v&&n.length+s>=r.endIndex){v={node:n,index:t++,text:n.data.substring(r.startIndex-s,r.endIndex-s),indexInMatch:s-r.startIndex,indexInNode:r.startIndex-s,endIndexInNode:r.endIndex-s,isEnd:true}}else{if(o){l.push({node:n,index:t++,text:n.data,indexInMatch:s-r.startIndex,indexInNode:0})}}if(!o&&n.length+s>r.startIndex){o={node:n,index:t++,indexInMatch:0,indexInNode:r.startIndex-s,endIndexInNode:r.endIndex-s,text:n.data.substring(r.startIndex-s,r.endIndex-s)}}s+=n.data.length}u=n.nodeType===1&&x&&!x(n);if(o&&v){n=this.replaceMatch(r,o,l,v);s-=(v.node.data.length-v.endIndexInNode);o=null;v=null;l=[];r=q.shift();t=0;w++;if(!r){break}}else{if(!u&&(n.firstChild||n.nextSibling)){if(n.firstChild){p.push(n);n=n.firstChild}else{n=n.nextSibling}continue}}while(true){if(n.nextSibling){n=n.nextSibling;break}n=p.pop();if(n===m){break out}}}},revert:function(){for(var m=this.reverts.length;m--;){this.reverts[m]()}this.reverts=[]},prepareReplacementString:function(o,n,m,l){var p=this.options.portionMode;if(p===b&&n.indexInMatch>0){return""}o=o.replace(/\$(\d+|&|`|')/g,function(q,r){var s;switch(r){case"&":s=m[0];break;case"`":s=m.input.substring(0,m.startIndex);break;case"'":s=m.input.substring(m.endIndex);break;default:s=m[+r]}return s});if(p===b){return o}if(n.isEnd){return o.substring(n.indexInMatch)}return o.substring(n.indexInMatch,n.indexInMatch+n.text.length)},getPortionReplacementNode:function(n,m,l){var p=this.options.replace||"$&";var r=this.options.wrap;if(r&&r.nodeType){var q=j.createElement("div");q.innerHTML=r.outerHTML||new XMLSerializer().serializeToString(r);r=q.firstChild}if(typeof p=="function"){p=p(n,m,l);if(p&&p.nodeType){return p}return j.createTextNode(String(p))}var o=typeof r=="string"?j.createElement(r):r;p=j.createTextNode(this.prepareReplacementString(p,n,m,l));if(!p.data){return p}if(!o){return p}o.appendChild(p);return o},replaceMatch:function(w,v,o,y){var p=v.node;var A=y.node;var q;var s;if(p===A){var r=p;if(v.indexInNode>0){q=j.createTextNode(r.data.substring(0,v.indexInNode));r.parentNode.insertBefore(q,r)}var z=this.getPortionReplacementNode(y,w);r.parentNode.insertBefore(z,r);if(y.endIndexInNode<r.length){s=j.createTextNode(r.data.substring(y.endIndexInNode));r.parentNode.insertBefore(s,r)}r.parentNode.removeChild(r);this.reverts.push(function(){if(q===z.previousSibling){q.parentNode.removeChild(q)}if(s===z.nextSibling){s.parentNode.removeChild(s)}z.parentNode.replaceChild(r,z)});return z}else{q=j.createTextNode(p.data.substring(0,v.indexInNode));s=j.createTextNode(A.data.substring(y.endIndexInNode));var m=this.getPortionReplacementNode(v,w);var x=[];for(var u=0,t=o.length;u<t;++u){var C=o[u];var B=this.getPortionReplacementNode(C,w);C.node.parentNode.replaceChild(B,C.node);this.reverts.push((function(l,D){return function(){D.parentNode.replaceChild(l.node,D)}}(C,B)));x.push(B)}var n=this.getPortionReplacementNode(y,w);p.parentNode.insertBefore(q,p);p.parentNode.insertBefore(m,p);p.parentNode.removeChild(p);A.parentNode.insertBefore(n,A);A.parentNode.insertBefore(s,A);A.parentNode.removeChild(A);this.reverts.push(function(){q.parentNode.removeChild(q);m.parentNode.replaceChild(p,m);s.parentNode.removeChild(s);n.parentNode.replaceChild(A,n)});return n}}};return g}));