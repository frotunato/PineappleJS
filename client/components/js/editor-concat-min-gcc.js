var editor=document.getElementById("editor"),editorButton=document.getElementById("editor-button"),editorHiddenInput=document.getElementById("editor-hidden-input"),editorFilenameInput=document.getElementById("editor-filename"),editorCtrl={resetCaretPosition:function(a){if(document.createRange){var b=document.getSelection();console.log("ended up selecting",b,a);this.getCurrentLine(b);rng=document.createRange();rng.selectNodeContents(a);rng.collapse(!1);b=window.getSelection();b.removeAllRanges();b.addRange(rng)}},
getCurrentLine:function(a,b,e){a=a?a:document.getSelection();var f=e?a:a.anchorNode;e=e?e:a;b=b?b:0;if(!f.parentNode.previousSibling&&"#text"===f.nodeName||"editor"===f.parentNode.id&&!f.previousSibling)return e.anchorNode.textContent.lastIndexOf(" "),a=(a=e.anchorNode.textContent.match(/[\/\s(](?!.*[\/\s(])/))?a.index+1:-1,{index:b,lastWord:e.anchorNode.textContent.substring(a,e.anchorOffset),lastSpacerOffset:a,sourceElement:e};if("DIV"===f.nodeName&&f.previousSibling)return this.getCurrentLine(f.previousSibling,
b+1,e);if("#text"===f.nodeName&&"editor"!==f.parentNode.id)return this.getCurrentLine(f.parentNode.previousSibling,b+1,e)},replaceReservedWords:function(){var a=this.getCurrentLine(),a=editor.childNodes[a.index],b=a.innerHTML.match(/(\bif\b|\belse\b|\bvar\b|[~=])(?!(<\/span>|"))/gi);if(b){console.log(b);var e=document.createElement("span"),f=document.createTextNode(""),p=document.getSelection();e.contentEditable="false";for(var l=b.length-1;0<=l;l--){switch(b[l]){case "~":e.className="coordinate";
break;case "=":case "if":case "else":e.className="control-flow-statement";break;case "var":e.className="variable"}findAndReplaceDOMText(a,{find:b[l],wrap:e});p.anchorNode.nextSibling?null:p.anchorNode.insertBefore(f,p.anchorNode.nextSibling)}editorCtrl.resetCaretPosition(a)}},fixEmptyParent:function(){if("<br>"===editor.innerHTML||""===editor.innerHTML){console.log("now");var a=document.createElement("div"),b=document.createElement("br");a.appendChild(b);"<br>"===editor.innerHTML?editor.replaceChild(a,
editor.firstChild):editor.appendChild(a)}},getTextContent:function(){for(var a="",b=0;b<editor.childNodes.length;b++)a+=editor.childNodes[b].textContent+"\n";console.log("str is",a);return a},setTextContent:function(){editorHiddenInput.value=editorCtrl.getTextContent()},sendTextContent:function(a){var b=new XMLHttpRequest;console.log("textContent is",a);b.onreadystatechange=function(){4===b.readyState&&console.log("we have something",b.responseText)};b.open("POST","schematic",!0);b.setRequestHeader("Content-Type",
"application/x-www-form-urlencoded; charset=UTF-8");b.send("source="+a)}},autocomplete={active:!1,matches:[],_lastIndex:0,_lastWord:"",_lastOffset:0,getMatchSet:function(a){var b="achievement ban ban-ip banlist blockdata clear clone debug defaultgamemode deop difficulty effect enchant entitydata execute fill gamemode gamerule give help kick kill list me op pardon particle playsound publish replaceitem save save-all save-off save-on say scoreboard seed setblock setidletimeout setworldspawn spawnpoint spreadplayers stats stop stopsound summon teleport tell tellraw testfor testforblock testforblocks time title toggledownfall tp trigger weather whitelist worldborder xp".split(" "),
e=[];a=a.replace("/","").replace("(","").replace("&nbsp;","");console.log("trying to match",a);for(var f=b.length-1;0<=f;f--)b[f].startsWith(a)&&e.push(b[f]);return e},reset:function(){this._lastWord="";this._lastIndex=this._lastOffset=0;this.active=!1;this.matches=[]},_replace:function(a,b,e){a=a.anchorNode;var f=this.matches[this._lastIndex];if(!f)this._lastIndex=0,f=this.matches[this._lastIndex];else if(e===f||0===this.matches.length)return;this._lastWord=f;this._lastIndex++;console.log("_replace here, working with",
e,"offset",b,"element",a);0<b&&(a.splitText(b),a=a.nextSibling);console.log("_replace here, working with next",f,"offset",b,"element",a);console.log("matches",this.matches);findAndReplaceDOMText(a,{find:e,replace:f});this._lastOffset=b+e.length},cycle:function(){var a=editorCtrl.getCurrentLine();this.active?(console.log("now going with",a.sourceElement),this._replace(a.sourceElement,-1,this._lastWord)):(this.matches=this.getMatchSet(a.lastWord),this.active=!0,this._replace(a.sourceElement,a.lastSpacerOffset,
a.lastWord))}};editor.onkeyup=function(a){a=String.fromCharCode(a.which);editorCtrl.fixEmptyParent();/[a-z\d]/i.test(a)&&(autocomplete.reset(),editorCtrl.replaceReservedWords())};editor.onkeydown=function(a){9===a.which&&(a.preventDefault(),autocomplete.cycle(editorCtrl.getCurrentLine()))};/*
 http://unlicense.org/UNLICENSE

 Matches the text of a DOM node against a regular expression
 and replaces each match (or node-separated portions of the match)
 in the specified element.
*/
(function(a,b){"object"===typeof module&&module.exports?module.exports=b():"function"===typeof define&&define.amd?define(b):a.findAndReplaceDOMText=b()})(this,function(){function a(){return b.apply(null,arguments)||e.apply(null,arguments)}function b(b,m,h,d,c){if(m&&!m.nodeType&&2>=arguments.length)return!1;var k="function"==typeof h;k&&(h=function(a){return function(c,d){return a(c.text,d.startIndex)}}(h));var g=e(m,{find:b,wrap:k?null:h,replace:k?h:"$"+(d||"&"),prepMatch:function(a,c){if(!a[0])throw"findAndReplaceDOMText cannot handle zero-length matches";
if(0<d){var g=a[d];a.index+=a[0].indexOf(g);a[0]=g}a.endIndex=a.index+a[0].length;a.startIndex=a.index;a.index=c;return a},filterElements:c});a.revert=function(){return g.revert()};return!0}function e(a,b){return new f(a,b)}function f(b,m){var h=m.preset&&a.PRESETS[m.preset];m.portionMode=m.portionMode||p;if(h)for(var d in h)r.call(h,d)&&!r.call(m,d)&&(m[d]=h[d]);this.node=b;this.options=m;this.prepMatch=m.prepMatch||this.prepMatch;this.reverts=[];this.matches=this.search();this.matches.length&&this.processMatches()}
var p="retain",l=document,r={}.hasOwnProperty;a.NON_PROSE_ELEMENTS={br:1,hr:1,script:1,style:1,img:1,video:1,audio:1,canvas:1,svg:1,map:1,object:1,input:1,textarea:1,select:1,option:1,optgroup:1,button:1};a.NON_CONTIGUOUS_PROSE_ELEMENTS={address:1,article:1,aside:1,blockquote:1,dd:1,div:1,dl:1,fieldset:1,figcaption:1,figure:1,footer:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,header:1,hgroup:1,hr:1,main:1,nav:1,noscript:1,ol:1,output:1,p:1,pre:1,section:1,ul:1,br:1,li:1,summary:1,dt:1,details:1,rp:1,rt:1,
rtc:1,script:1,style:1,img:1,video:1,audio:1,canvas:1,svg:1,map:1,object:1,input:1,textarea:1,select:1,option:1,optgroup:1,button:1,table:1,tbody:1,thead:1,th:1,tr:1,td:1,caption:1,col:1,tfoot:1,colgroup:1};a.NON_INLINE_PROSE=function(b){return r.call(a.NON_CONTIGUOUS_PROSE_ELEMENTS,b.nodeName.toLowerCase())};a.PRESETS={prose:{forceContext:a.NON_INLINE_PROSE,filterElements:function(b){return!r.call(a.NON_PROSE_ELEMENTS,b.nodeName.toLowerCase())}}};a.Finder=f;f.prototype={search:function(){function a(k){for(var f=
0,l=k.length;f<l;++f){var n=k[f];if("string"!==typeof n)a(n);else{if(c.global)for(;b=c.exec(n);)g.push(e.prepMatch(b,h++,d));else(b=n.match(c))&&g.push(e.prepMatch(b,0,d));d+=n.length}}}var b,h=0,d=0,c=this.options.find,k=this.getAggregateText(),g=[],e=this,c="string"===typeof c?RegExp(String(c).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1"),"g"):c;a(k);return g},prepMatch:function(a,b,h){if(!a[0])throw Error("findAndReplaceDOMText cannot handle zero-length matches");a.endIndex=h+a.index+a[0].length;
a.startIndex=h+a.index;a.index=b;return a},getAggregateText:function(){function a(d,c){if(3===d.nodeType)return[d.data];if(b&&!b(d))return[];c=[""];var k=0;if(d=d.firstChild){do if(3===d.nodeType)c[k]+=d.data;else{var g=a(d);h&&1===d.nodeType&&(!0===h||h(d))?(c[++k]=g,c[++k]=""):("string"===typeof g[0]&&(c[k]+=g.shift()),g.length&&(c[++k]=g,c[++k]=""))}while(d=d.nextSibling)}return c}var b=this.options.filterElements,h=this.options.forceContext;return a(this.node)},processMatches:function(){var a=
this.matches,b=this.node,h=this.options.filterElements,d,c,k=[],g=b,f=a.shift(),e=0,l=0,s=0,n,t=[b];a:for(;;){3===g.nodeType&&(!c&&g.length+e>=f.endIndex?c={node:g,index:s++,text:g.data.substring(f.startIndex-e,f.endIndex-e),indexInMatch:e-f.startIndex,indexInNode:f.startIndex-e,endIndexInNode:f.endIndex-e,isEnd:!0}:d&&k.push({node:g,index:s++,text:g.data,indexInMatch:e-f.startIndex,indexInNode:0}),!d&&g.length+e>f.startIndex&&(d={node:g,index:s++,indexInMatch:0,indexInNode:f.startIndex-e,endIndexInNode:f.endIndex-
e,text:g.data.substring(f.startIndex-e,f.endIndex-e)}),e+=g.data.length);n=1===g.nodeType&&h&&!h(g);if(d&&c){if(g=this.replaceMatch(f,d,k,c),e-=c.node.data.length-c.endIndexInNode,c=d=null,k=[],f=a.shift(),s=0,l++,!f)break}else if(!n&&(g.firstChild||g.nextSibling)){g.firstChild?(t.push(g),g=g.firstChild):g=g.nextSibling;continue}for(;;){if(g.nextSibling){g=g.nextSibling;break}g=t.pop();if(g===b)break a}}},revert:function(){for(var a=this.reverts.length;a--;)this.reverts[a]();this.reverts=[]},prepareReplacementString:function(a,
b,e,d){d=this.options.portionMode;if("first"===d&&0<b.indexInMatch)return"";a=a.replace(/\$(\d+|&|`|')/g,function(a,b){var d;switch(b){case "&":d=e[0];break;case "`":d=e.input.substring(0,e.startIndex);break;case "'":d=e.input.substring(e.endIndex);break;default:d=e[+b]}return d});return"first"===d?a:b.isEnd?a.substring(b.indexInMatch):a.substring(b.indexInMatch,b.indexInMatch+b.text.length)},getPortionReplacementNode:function(a,b,e){var d=this.options.replace||"$&",c=this.options.wrap;if(c&&c.nodeType){var f=
l.createElement("div");f.innerHTML=c.outerHTML||(new XMLSerializer).serializeToString(c);c=f.firstChild}if("function"==typeof d)return(d=d(a,b,e))&&d.nodeType?d:l.createTextNode(String(d));c="string"==typeof c?l.createElement(c):c;d=l.createTextNode(this.prepareReplacementString(d,a,b,e));if(!d.data||!c)return d;c.appendChild(d);return c},replaceMatch:function(a,b,e,d){var c=b.node,f=d.node,g,q;if(c===f){0<b.indexInNode&&(g=l.createTextNode(c.data.substring(0,b.indexInNode)),c.parentNode.insertBefore(g,
c));var u=this.getPortionReplacementNode(d,a);c.parentNode.insertBefore(u,c);d.endIndexInNode<c.length&&(q=l.createTextNode(c.data.substring(d.endIndexInNode)),c.parentNode.insertBefore(q,c));c.parentNode.removeChild(c);this.reverts.push(function(){g===u.previousSibling&&g.parentNode.removeChild(g);q===u.nextSibling&&q.parentNode.removeChild(q);u.parentNode.replaceChild(c,u)});return u}g=l.createTextNode(c.data.substring(0,b.indexInNode));q=l.createTextNode(f.data.substring(d.endIndexInNode));var p=
this.getPortionReplacementNode(b,a);b=[];for(var s=0,n=e.length;s<n;++s){var t=e[s],r=this.getPortionReplacementNode(t,a);t.node.parentNode.replaceChild(r,t.node);this.reverts.push(function(a,b){return function(){b.parentNode.replaceChild(a.node,b)}}(t,r));b.push(r)}var v=this.getPortionReplacementNode(d,a);c.parentNode.insertBefore(g,c);c.parentNode.insertBefore(p,c);c.parentNode.removeChild(c);f.parentNode.insertBefore(v,f);f.parentNode.insertBefore(q,f);f.parentNode.removeChild(f);this.reverts.push(function(){g.parentNode.removeChild(g);
p.parentNode.replaceChild(c,p);q.parentNode.removeChild(q);v.parentNode.replaceChild(f,v)});return v}};return a});
